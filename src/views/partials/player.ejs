<% const trackList = (tracks && Array.isArray(tracks.items)) ? tracks.items : []; %>
<% if (trackList.length) { %>
  <% const firstTrack = trackList[0]; %>
  <% const albumTitle = (tracks && (tracks.title || tracks.albumTitle)) ? (tracks.title || tracks.albumTitle) : '0d239 playback console'; %>
  <% const albumSubtitle = (tracks && (tracks.subtitle || tracks.albumSubtitle)) ? (tracks.subtitle || tracks.albumSubtitle) : ''; %>
  <% const albumNote = (tracks && tracks.note) ? tracks.note : ''; %>
  <% const startMode = (typeof playerMode === 'string' && playerMode.toLowerCase() === 'expanded') ? 'expanded' : 'compact'; %>
  <aside class="album-player ascii tilt <%= startMode === 'compact' ? 'is-compact' : '' %>" data-album-title="<%= albumTitle %>" data-player-mode="<%= startMode %>">
    <div class="album-body">
      <figure class="album-cover">
        <div class="album-cover-frame">
          <button type="button" class="album-cover-toggle" aria-label="play" aria-pressed="false" data-state="paused">
            <img class="album-cover-art" src="<%= firstTrack.coverArt %>" alt="<%= firstTrack.coverAlt || ('Cover art for ' + firstTrack.title) %>" loading="lazy">
          </button>
        </div>
        <div class="album-cover-console" role="group" aria-label="playback controls">
          <div class="album-console-frame">
            <div class="album-console-line" aria-hidden="true">┌────────────────────────────────┐</div>
            <div class="album-console-body">
              <span class="album-console-brace" aria-hidden="true">│</span>
              <button type="button" class="album-console-btn album-skip album-skip-prev" data-direction="-1" aria-label="previous track">
                <span class="album-console-icon" aria-hidden="true">&lt;&lt;</span>
                <span class="album-console-text" aria-hidden="true"> prev</span>
                <span class="sr-only">previous track</span>
              </button>
              <button type="button" class="album-console-btn album-play-toggle" aria-label="play">
                <span class="album-console-icon" aria-hidden="true">&gt;</span>
                <span class="album-play-label" aria-hidden="true"> play</span>
                <span class="sr-only">play or pause</span>
              </button>
              <button type="button" class="album-console-btn album-skip album-skip-next" data-direction="1" aria-label="next track">
                <span class="album-console-text" aria-hidden="true">next </span>
                <span class="album-console-icon" aria-hidden="true">&gt;&gt;</span>
                <span class="sr-only">next track</span>
              </button>
              <span class="album-console-divider" aria-hidden="true">│</span>
              <div class="album-progress" role="group" aria-label="track position">
                <span class="album-progress-label" aria-hidden="true">trk</span>
                <div class="album-meter">
                  <div class="album-meter-track">
                    <span class="album-progress-ascii" aria-hidden="true" data-progress-text>[--------------------]</span>
                    <input class="album-progress-input" type="range" min="0" max="100" value="0" step="1" aria-label="track position">
                  </div>
                  <span class="album-progress-display" aria-hidden="true">
                    <span class="album-progress-current">0:00</span>
                    <span class="album-progress-separator"> / </span>
                    <span class="album-progress-duration">--:--</span>
                  </span>
                </div>
              </div>
              <span class="album-console-divider" aria-hidden="true">│</span>
              <div class="album-volume" role="group" aria-label="volume">
                <span class="album-volume-label" aria-hidden="true">vol</span>
                <div class="album-meter">
                  <div class="album-meter-track">
                    <span class="album-volume-ascii" aria-hidden="true" data-volume-text>[----------]</span>
                    <input class="album-volume-input" type="range" min="0" max="100" value="100" aria-label="volume">
                  </div>
                  <span class="album-volume-display" aria-hidden="true">100%</span>
                </div>
              </div>
              <span class="album-console-brace" aria-hidden="true">│</span>
            </div>
            <div class="album-console-line" aria-hidden="true">└────────────────────────────────┘</div>
          </div>
        </div>
        <% if (albumSubtitle || albumNote) { %>
          <figcaption class="album-cover-caption">
            <span><%= albumSubtitle %><%= (albumSubtitle && albumNote) ? ' · ' : '' %><%= albumNote %></span>
          </figcaption>
        <% } %>
      </figure>
      <div class="album-content">
        <% const firstMeta = [firstTrack.year, firstTrack.description].filter(Boolean).join(' — '); %>
        <div class="album-now-playing">
          <div class="album-now-label">now playing</div>
          <div class="album-current-title"><%= firstTrack.title %></div>
          <% if (firstMeta) { %>
            <div class="album-current-meta"><%= firstMeta %></div>
          <% } else { %>
            <div class="album-current-meta" hidden></div>
          <% } %>
        </div>
        <ol class="album-tracklist" role="listbox" aria-label="tracklist">
          <% trackList.forEach(function(track, index){ %>
            <li class="album-track <%= index === 0 ? 'is-active' : '' %>">
              <button
                type="button"
                class="album-track-button"
                role="option"
                aria-selected="<%= index === 0 ? 'true' : 'false' %>"
                data-index="<%= index %>"
                data-slug="<%= track.slug %>"
                data-title="<%= track.title %>"
                data-audio="<%= track.audio %>"
                data-lyrics="<%= track.lyrics || track.transcript %>"
                data-commentary="<%= track.commentary || '' %>"
                data-year="<%= track.year %>"
                data-description="<%= track.description %>"
              >
                <span class="album-track-num"><%= String(index + 1).padStart(2, '0') %>.</span>
                <span class="album-track-name"><%= track.title %></span>
              </button>
            </li>
          <% }); %>
        </ol>
        <div class="album-controls">
          <audio class="album-audio" controls preload="none" src="<%= firstTrack.audio %>"></audio>
          <details class="album-lyrics">
            <summary>lyrics / commentary</summary>
            <div class="album-annotations" data-active="lyrics">
              <div class="album-annotations-tabs" role="tablist" aria-label="lyrics and commentary">
                <button type="button" class="album-annotations-tab is-active" data-view="lyrics" role="tab" aria-selected="true" aria-controls="album-annotations-lyrics">lyrics</button>
                <button type="button" class="album-annotations-tab" data-view="commentary" role="tab" aria-selected="false" aria-controls="album-annotations-commentary">commentary</button>
              </div>
              <div class="album-annotations-panels">
                <pre
                  id="album-annotations-lyrics"
                  class="album-annotations-body is-active"
                  data-view="lyrics"
                  data-placeholder="open to fetch lyrics"
                  data-loading-text="loading lyrics…"
                  data-error-text="(error loading lyrics)"
                  data-empty-text="(no lyrics)"
                  role="tabpanel"
                  aria-label="track lyrics"
                >open to fetch lyrics</pre>
                <pre
                  id="album-annotations-commentary"
                  class="album-annotations-body"
                  data-view="commentary"
                  data-placeholder="select commentary tab to load"
                  data-loading-text="loading commentary…"
                  data-error-text="(error loading commentary)"
                  data-empty-text="(no commentary yet)"
                  role="tabpanel"
                  aria-label="track commentary"
                >select commentary tab to load</pre>
              </div>
            </div>
          </details>
        </div>
      </div>
    </div>
    <button type="button" class="album-toggle" aria-expanded="<%= startMode === 'expanded' ? 'true' : 'false' %>">
      <span class="album-toggle-label">toggle console</span>
    </button>
  </aside>
<% } %>
